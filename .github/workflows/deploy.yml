name: Deploy to PyPI

on:
  workflow_run:
    workflows: ["Tests"]
    branches: [main, master]
    types:
      - completed

jobs:
  deploy:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    # Only deploy if tests passed AND the push was to main/master branch
    if: ${{ github.event.workflow_run.conclusion == 'success' && (github.event.workflow_run.head_branch == 'main' || github.event.workflow_run.head_branch == 'master') }}
    
    steps:
    - name: Checkout code from the test workflow
      uses: actions/checkout@v5
      with:
        ref: ${{ github.event.workflow_run.head_branch }}
        fetch-depth: 0  # Fetch all history for tags
    
    - name: Set up Python
      uses: actions/setup-python@v6
      with:
        python-version: "3.12"
        cache: 'pip'
    
    - name: Install system dependencies for geospatial libraries
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          libgeos-dev \
          proj-data \
          proj-bin \
          libproj-dev \
          gdal-bin \
          libgdal-dev
    
    - name: Install build dependencies
      run: |
        python -m pip install --upgrade pip
        pip install build twine requests
    
    - name: Extract version from pyproject.toml
      id: version
      working-directory: ./sigmap-pytools
      run: |
        VERSION=$(python -c "import tomllib; f=open('pyproject.toml', 'rb'); data=tomllib.load(f); print(data['project']['version'])")
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "tag=v$VERSION" >> $GITHUB_OUTPUT
        echo "Version: $VERSION"
    
    - name: Check if version already exists on PyPI
      working-directory: ./sigmap-pytools
      run: |
        VERSION="${{ steps.version.outputs.version }}"
        PACKAGE_NAME="sigmap-pytools"
        
        echo "Checking if version $VERSION already exists on PyPI..."
        python << EOF
        import requests
        import sys
        
        version = "$VERSION"
        package_name = "$PACKAGE_NAME"
        
        try:
            url = f'https://pypi.org/pypi/{package_name}/{version}/json'
            response = requests.get(url, timeout=10)
            if response.status_code == 200:
                print(f'❌ ERROR: Version {version} already exists on PyPI!')
                print('You must increment the version in pyproject.toml before deploying.')
                print(f'Current version: {version}')
                # Suggest next version
                parts = version.split('.')
                if len(parts) >= 3:
                    parts[2] = str(int(parts[2]) + 1)
                    suggested = '.'.join(parts)
                    print(f'Suggested next version: {suggested}')
                else:
                    print('Suggested next version: 0.0.2 (or higher)')
                sys.exit(1)
            elif response.status_code == 404:
                print(f'✅ Version {version} is available for upload')
                sys.exit(0)
            else:
                print(f'⚠️  Unexpected status code: {response.status_code}')
                print('Proceeding anyway...')
                sys.exit(0)
        except Exception as e:
            print(f'⚠️  Could not check PyPI: {e}')
            print('Proceeding anyway (PyPI might be temporarily unavailable)...')
            sys.exit(0)
        EOF
    
    - name: Build package
      working-directory: ./sigmap-pytools
      run: |
        python -m build
    
    - name: Check package
      working-directory: ./sigmap-pytools
      run: |
        python -m twine check dist/*
    
    - name: Publish to PyPI
      working-directory: ./sigmap-pytools
      env:
        TWINE_USERNAME: __token__
        TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
      run: |
        python -m twine upload dist/*
    
    - name: Configure Git
      run: |
        git config --local user.email "action@github.com"
        git config --local user.name "GitHub Action"
    
    - name: Check if tag exists
      id: check_tag
      run: |
        TAG="${{ steps.version.outputs.tag }}"
        if git rev-parse "$TAG" >/dev/null 2>&1; then
          echo "exists=true" >> $GITHUB_OUTPUT
          echo "Tag $TAG already exists, skipping release creation"
        else
          echo "exists=false" >> $GITHUB_OUTPUT
          echo "Tag $TAG does not exist, will create release"
        fi
    
    - name: Create and push tag
      if: steps.check_tag.outputs.exists == 'false'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        TAG="${{ steps.version.outputs.tag }}"
        git tag -a "$TAG" -m "Release $TAG"
        git push origin "$TAG"
    
    - name: Create GitHub Release
      if: steps.check_tag.outputs.exists == 'false'
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.version.outputs.tag }}
        name: Release ${{ steps.version.outputs.version }}
        body: |
          ## Release ${{ steps.version.outputs.version }}
          
          This release corresponds to version ${{ steps.version.outputs.version }} published to PyPI.
          
          ### Installation
          ```bash
          pip install sigmap-pytools==${{ steps.version.outputs.version }}
          ```
          
          ### Changes
          See the [full changelog](https://github.com/${{ github.repository }}/compare/${{ steps.version.outputs.tag }}...main) for details.
        draft: false
        prerelease: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

